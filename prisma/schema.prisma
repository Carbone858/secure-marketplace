generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  COMPANY
  ADMIN
  SUPER_ADMIN
}

enum RequestStatus {
  DRAFT
  PENDING
  ACTIVE
  MATCHING
  REVIEWING_OFFERS
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  EXPIRED
}

enum UrgencyLevel {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum VisibilityLevel {
  PUBLIC
  REGISTERED_ONLY
  VERIFIED_COMPANIES
}

enum OfferStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
  EXPIRED
}

enum ProjectStatus {
  PENDING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum MembershipDuration {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum MembershipStatus {
  ACTIVE
  CANCELLED
  EXPIRED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum NotificationType {
  MESSAGE
  PROJECT
  OFFER
  REQUEST
  SYSTEM
}

enum SubscriptionPlan {
  FREE
  BASIC
  PREMIUM
  ENTERPRISE
}

model User {
  id                 String    @id @default(uuid())
  email              String    @unique
  emailHash          String    @unique
  password           String
  name               String?
  phone              String?
  role               UserRole  @default(USER)
  avatar             String?
  image              String?
  emailVerified      DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  isActive           Boolean   @default(true)
  
  // Account lockout fields
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  
  // Relations
  company               Company?               @relation("CompanyOwner")
  companiesVerified     Company[]              @relation("CompanyVerifier")
  requests              ServiceRequest[]
  securityLogs          SecurityLog[]
  refreshTokens         RefreshToken[]
  notificationSettings  NotificationSettings?
  userSettings          UserSettings?
  messagesSent          Message[]               @relation("MessageSender")
  messagesReceived      Message[]               @relation("MessageRecipient")
  notifications         Notification[]
  reviews               Review[]
  projects              Project[]
  cmsPagesCreated       CMSPage[]               @relation("CmsPageCreatedBy")
  cmsPagesUpdated       CMSPage[]               @relation("CmsPageUpdatedBy")
  staffMember           StaffMember?
  internalSent          InternalMessage[]        @relation("InternalSender")
  internalReceived      InternalMessage[]        @relation("InternalRecipient")
  
  @@map("users")
}

enum CompanyVerificationStatus {
  PENDING
  UNDER_REVIEW
  VERIFIED
  REJECTED
  EXPIRED
}

model Company {
  id                  String                     @id @default(uuid())
  userId              String                     @unique
  name                String
  slug                String                     @unique
  description         String?                    @db.Text
  logo                String?
  website             String?
  email               String?
  phone               String?
  countryId           String?
  cityId              String?
  address             String?
  verificationStatus  CompanyVerificationStatus  @default(PENDING)
  verifiedAt          DateTime?
  verifiedBy          String?
  isActive            Boolean                    @default(true)
  isFeatured          Boolean                    @default(false)
  rating              Float                      @default(0)
  reviewCount         Int                        @default(0)
  currentPlan         SubscriptionPlan           @default(FREE)
  createdAt           DateTime                   @default(now())
  updatedAt           DateTime                   @updatedAt
  
  // Relations
  user                User                       @relation("CompanyOwner", fields: [userId], references: [id], onDelete: Cascade)
  country             Country?                   @relation(fields: [countryId], references: [id])
  city                City?                      @relation(fields: [cityId], references: [id])
  verifiedByUser       User?                      @relation("CompanyVerifier", fields: [verifiedBy], references: [id])
  documents           CompanyDocument[]
  services            CompanyService[]
  workingHours        CompanyWorkingHours?
  socialLinks         CompanySocialLinks?
  offers              Offer[]
  reviews             Review[]
  projects            Project[]
  memberships         Membership[]
  payments            Payment[]
  matchingPreference  CompanyMatchingPreference?
  portfolio           CompanyPortfolioItem[]
  
  @@map("companies")
}

model CompanyDocument {
  id            String    @id @default(uuid())
  companyId     String
  type          String    // LICENSE, ID_CARD, COMMERCIAL_REGISTER, etc.
  fileUrl       String
  fileName      String
  mimeType      String
  fileSize      Int
  status        String    @default("PENDING") // PENDING, APPROVED, REJECTED
  adminNotes    String?
  uploadedAt    DateTime  @default(now())
  reviewedAt    DateTime?
  
  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
  @@map("company_documents")
}

model CompanyService {
  id            String    @id @default(uuid())
  companyId     String
  name          String
  description   String?   @db.Text
  priceFrom     Float?
  priceTo       Float?
  isActive      Boolean   @default(true)
  tags          String[]  @default([])
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
  @@map("company_services")
}

model CompanyWorkingHours {
  id            String    @id @default(uuid())
  companyId     String    @unique
  
  // Working hours for each day (format: "09:00-17:00" or null for closed)
  monday        String?
  tuesday       String?
  wednesday     String?
  thursday      String?
  friday        String?
  saturday      String?
  sunday        String?
  
  timeZone      String    @default("UTC")
  
  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@map("company_working_hours")
}

model CompanySocialLinks {
  id            String    @id @default(uuid())
  companyId     String    @unique
  
  facebook      String?
  twitter       String?
  instagram     String?
  linkedin      String?
  youtube       String?
  
  company       Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@map("company_social_links")
}

model Country {
  id          String   @id @default(uuid())
  code        String   @unique
  nameAr      String
  nameEn      String
  isActive    Boolean  @default(true)
  cities      City[]
  companies   Company[]
  requests    ServiceRequest[]
  
  @@map("countries")
}

model City {
  id          String   @id @default(uuid())
  countryId   String
  nameAr      String
  nameEn      String
  slug        String
  isActive    Boolean  @default(true)
  
  country     Country  @relation(fields: [countryId], references: [id], onDelete: Cascade)
  companies   Company[]
  requests    ServiceRequest[]
  areas       Area[]
  
  @@unique([countryId, slug])
  @@map("cities")
}

model ServiceRequest {
  id                 String          @id @default(uuid())
  userId             String
  title              String
  description        String          @db.Text
  categoryId         String
  subcategoryId      String?
  countryId          String
  cityId             String
  areaId             String?
  address            String?
  budgetMin          Float?
  budgetMax          Float?
  currency           String          @default("USD")
  deadline           DateTime?
  urgency            UrgencyLevel    @default(MEDIUM)
  visibility         VisibilityLevel @default(PUBLIC)
  images             Json?
  attachments        Json?
  tags               String[]        @default([])
  allowRemote        Boolean         @default(false)
  requireVerification Boolean        @default(false)
  status             RequestStatus   @default(PENDING)
  isActive           Boolean         @default(true)
  viewCount          Int             @default(0)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  user               User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  category           Category        @relation(fields: [categoryId], references: [id])
  subcategory        Category?       @relation("Subcategory", fields: [subcategoryId], references: [id])
  country            Country         @relation(fields: [countryId], references: [id])
  city               City            @relation(fields: [cityId], references: [id])
  area               Area?           @relation(fields: [areaId], references: [id])
  offers             Offer[]
  projects           Project[]
  messages           Message[]

  @@index([categoryId])
  @@index([countryId])
  @@index([cityId])
  @@map("service_requests")
}

model Category {
  id          String      @id @default(uuid())
  name        String
  nameEn      String
  nameAr      String
  slug        String      @unique
  icon        String?
  iconName    String?     // Lucide icon name (e.g. "wrench", "building2")
  imageUrl    String?     // Optional category image
  sortOrder   Int         @default(0)
  isActive    Boolean     @default(true)
  isFeatured  Boolean     @default(false)
  parentId    String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  parent      Category?   @relation("CategoryParent", fields: [parentId], references: [id])
  children    Category[]  @relation("CategoryParent")
  requests    ServiceRequest[]
  subRequests ServiceRequest[] @relation("Subcategory")

  @@index([parentId])
  @@map("categories")
}

model Area {
  id        String   @id @default(uuid())
  cityId    String
  nameEn    String
  nameAr    String
  slug      String
  isActive  Boolean  @default(true)

  city      City     @relation(fields: [cityId], references: [id], onDelete: Cascade)
  requests  ServiceRequest[]

  @@unique([cityId, slug])
  @@map("areas")
}

model Offer {
  id            String      @id @default(uuid())
  requestId     String
  companyId     String
  price         Float
  currency      String      @default("USD")
  description   String?
  estimatedDays Int?
  attachments   Json?
  message       String?
  status        OfferStatus @default(PENDING)
  expiresAt     DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  request       ServiceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@index([companyId])
  @@map("offers")
}

model Review {
  id        String   @id @default(uuid())
  companyId String
  userId    String
  projectId String?
  rating    Int
  comment   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   Project? @relation(fields: [projectId], references: [id])

  @@index([companyId])
  @@index([userId])
  @@map("reviews")
}

model Project {
  id          String        @id @default(uuid())
  title       String
  description String        @db.Text
  userId      String
  companyId   String
  requestId   String?
  startDate   DateTime?
  endDate     DateTime?
  budget      Float?
  currency    String        @default("USD")
  status      ProjectStatus @default(PENDING)
  progress    Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  company     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  request     ServiceRequest? @relation(fields: [requestId], references: [id])
  milestones  ProjectMilestone[]
  files       ProjectFile[]
  messages    Message[]
  reviews     Review[]

  @@index([userId])
  @@index([companyId])
  @@map("projects")
}

model ProjectMilestone {
  id          String   @id @default(uuid())
  projectId   String
  title       String
  description String?
  dueDate     DateTime?
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("project_milestones")
}

model ProjectFile {
  id          String   @id @default(uuid())
  projectId   String
  name        String
  url         String
  mimeType    String?
  size        Int?
  uploadedBy  String?
  createdAt   DateTime @default(now())

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("project_files")
}

model Message {
  id          String   @id @default(uuid())
  senderId    String
  recipientId String
  content     String   @db.Text
  isRead      Boolean  @default(false)
  projectId   String?
  requestId   String?
  createdAt   DateTime @default(now())

  sender      User     @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  recipient   User     @relation("MessageRecipient", fields: [recipientId], references: [id], onDelete: Cascade)
  project     Project? @relation(fields: [projectId], references: [id])
  request     ServiceRequest? @relation(fields: [requestId], references: [id])

  @@index([senderId])
  @@index([recipientId])
  @@map("messages")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notifications")
}

model MembershipPlan {
  id          String             @id @default(uuid())
  name        String             @unique
  description String?
  price       Float
  currency    String             @default("USD")
  duration    MembershipDuration @default(MONTHLY)
  features    Json?
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  memberships Membership[]

  @@map("membership_plans")
}

model Membership {
  id            String            @id @default(uuid())
  companyId     String
  planId        String
  startDate     DateTime
  endDate       DateTime
  status        MembershipStatus  @default(ACTIVE)
  autoRenew     Boolean           @default(false)
  paymentMethod String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  company       Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  plan          MembershipPlan    @relation(fields: [planId], references: [id], onDelete: Cascade)
  payments      Payment[]

  @@index([companyId])
  @@index([planId])
  @@map("memberships")
}

model Payment {
  id            String        @id @default(uuid())
  membershipId  String
  companyId     String
  amount        Float
  currency      String        @default("USD")
  status        PaymentStatus @default(PENDING)
  paymentMethod String?
  description   String?
  createdAt     DateTime      @default(now())

  membership    Membership    @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  company       Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([membershipId])
  @@index([companyId])
  @@map("payments")
}

model CMSPage {
  id              String   @id @default(uuid())
  title           String
  titleAr         String?
  slug            String   @unique
  content         String   @db.Text
  contentAr       String?
  metaDescription String?
  metaKeywords    String?
  isPublished     Boolean  @default(true)
  createdBy       String?
  updatedBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  createdByUser   User?    @relation("CmsPageCreatedBy", fields: [createdBy], references: [id])
  updatedByUser   User?    @relation("CmsPageUpdatedBy", fields: [updatedBy], references: [id])

  @@map("cms_pages")
}

model CMSSection {
  id            String    @id @default(uuid())
  name          String    @unique
  identifier    String    @unique
  page          String    @default("home")
  content       Json
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("cms_sections")
}

model VerificationToken {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())
  
  @@unique([email, token])
  @@map("verification_tokens")
}

enum SecurityLogType {
  LOGIN
  LOGIN_FAILED
  LOGOUT
  REGISTER
  REGISTER_FAILED
  PASSWORD_RESET
  PASSWORD_RESET_FAILED
  EMAIL_VERIFIED
  EMAIL_VERIFICATION_FAILED
  ACCOUNT_LOCKED
  SUSPICIOUS_ACTIVITY
}

model SecurityLog {
  id        String        @id @default(uuid())
  userId    String?
  type      SecurityLogType
  ip        String
  userAgent String?
  metadata  Json?
  createdAt DateTime      @default(now())
  
  user      User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("security_logs")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())
  usedAt    DateTime?
  
  @@unique([email, token])
  @@index([email])
  @@index([token])
  @@map("password_reset_tokens")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  revokedAt DateTime?
  ipAddress String?
  userAgent String?
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ========================================
// Feature Flags (Phase 2 Preparation)
// ========================================
model FeatureFlag {
  id          String   @id @default(uuid())
  key         String   @unique
  value       Boolean  @default(false)
  description String?
  category    String   @default("general")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("feature_flags")
}

// ========================================
// Smart Matching Preferences
// ========================================
model CompanyMatchingPreference {
  id           String   @id @default(uuid())
  companyId    String   @unique
  categoryIds  String[] @default([])
  cityIds      String[] @default([])
  budgetMin    Float?
  budgetMax    Float?
  urgencyLevels String[] @default([])
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@map("company_matching_preferences")
}

// ========================================
// Company Portfolio
// ========================================
model CompanyPortfolioItem {
  id          String   @id @default(uuid())
  companyId   String
  title       String
  description String?  @db.Text
  imageUrl    String?
  projectUrl  String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
  @@map("company_portfolio_items")
}

// ========================================
// Staff Roles & Departments (Admin)
// ========================================
model StaffRole {
  id          String   @id @default(uuid())
  name        String   @unique
  nameAr      String?
  description String?
  permissions Json     @default("[]")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  staffMembers StaffMember[]
  
  @@map("staff_roles")
}

model Department {
  id          String   @id @default(uuid())
  name        String   @unique
  nameAr      String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  staffMembers StaffMember[]
  
  @@map("departments")
}

model StaffMember {
  id           String      @id @default(uuid())
  userId       String
  roleId       String?
  departmentId String?
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  role         StaffRole?  @relation(fields: [roleId], references: [id])
  department   Department? @relation(fields: [departmentId], references: [id])
  
  @@unique([userId])
  @@map("staff_members")
}

// ========================================
// Internal Communication (Staff)
// ========================================
model InternalMessage {
  id          String   @id @default(uuid())
  senderId    String
  recipientId String?
  departmentId String?
  subject     String
  content     String   @db.Text
  isRead      Boolean  @default(false)
  priority    String   @default("NORMAL")
  createdAt   DateTime @default(now())
  
  sender      User     @relation("InternalSender", fields: [senderId], references: [id], onDelete: Cascade)
  recipient   User?    @relation("InternalRecipient", fields: [recipientId], references: [id])
  
  @@index([senderId])
  @@index([recipientId])
  @@map("internal_messages")
}

model NotificationSettings {
  id                    String   @id @default(uuid())
  userId                String   @unique
  
  // Email notifications
  emailNewOffers        Boolean  @default(true)
  emailRequestUpdates   Boolean  @default(true)
  emailMessages         Boolean  @default(true)
  emailMarketing        Boolean  @default(false)
  emailSecurityAlerts   Boolean  @default(true)
  
  // Push notifications
  pushNewOffers         Boolean  @default(true)
  pushRequestUpdates    Boolean  @default(true)
  pushMessages          Boolean  @default(true)
  
  // SMS notifications
  smsSecurityAlerts     Boolean  @default(true)
  smsMarketing          Boolean  @default(false)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("notification_settings")
}

model UserSettings {
  id                    String   @id @default(uuid())
  userId                String   @unique
  
  // Privacy settings
  profileVisible        Boolean  @default(true)
  showEmail             Boolean  @default(false)
  showPhone             Boolean  @default(false)
  allowDirectMessages   Boolean  @default(true)
  
  // Language & Region
  language              String   @default("en")
  timezone              String   @default("UTC")
  
  // Account deletion
  deletionRequestedAt   DateTime?
  deletionReason        String?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_settings")
}
